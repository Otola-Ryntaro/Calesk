# チケット023: セッション永続化（壁紙キャッシュ保持）

## 背景
- スリープ復帰後のログイン画面にカレンダー壁紙が表示される（良い挙動）
- しかしログアウト・再起動時にカレンダー内容がリセットされ、予定が空になる
- 前回セッションの壁紙を保持し、オフラインでも最新の壁紙が表示されるようにしたい

## 要件
1. 壁紙生成時にキャッシュとしてメタデータ（テーマ、日付、イベント情報）を保存する
2. アプリ起動時にGoogle API接続不可の場合、キャッシュから壁紙を復元する
3. キャッシュ壁紙を復元する際、現在時刻ハイライトは表示しない（古い時刻情報のため）
4. キャッシュは最新1枚のみ保持（ディスク肥大化防止）

## 現状分析
- 壁紙は `output/wallpaper_{theme}_{date}.png` に保存される
- キャッシュ機構は未実装
- 毎回フルで画像生成している
- スリープ復帰時は即座に壁紙更新を実行（`_on_sleep_check()`）

## 設計方針

### キャッシュメタデータ (`~/.config/calender_desktop/cache_meta.json`)
```json
{
  "last_wallpaper_path": "/path/to/wallpaper_simple_20260211.png",
  "theme": "simple",
  "generated_at": "2026-02-11T10:30:00+09:00",
  "events_hash": "abc123..."
}
```

### 壁紙復元フロー
```
アプリ起動
├─ Google API接続可能?
│  ├─ Yes → 通常通り壁紙生成
│  └─ No → キャッシュから復元
│     ├─ cache_meta.json存在?
│     │  ├─ Yes → キャッシュ壁紙をそのまま設定（時刻ハイライトなし）
│     │  └─ No → デフォルト壁紙（予定なし版）を生成
```

## タスク
- [ ] cache_meta.json の保存・読み込み機能を WallpaperService に追加
- [ ] 壁紙生成成功時にメタデータを自動保存
- [ ] アプリ起動時にキャッシュ復元ロジックを追加
- [ ] ImageGenerator に current_time_highlight 無効化オプションを追加
- [ ] キャッシュ復元のテストを追加
- [ ] スリープ復帰 → オフライン時のテストを追加

## テスト方針
- cache_meta.json の保存・読み込み単体テスト
- オフライン時のキャッシュ復元統合テスト
- 現在時刻ハイライト無効化の描画テスト
