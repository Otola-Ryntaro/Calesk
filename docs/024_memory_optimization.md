# チケット024: バックグラウンドメモリ消費削減

## 背景
- バックグラウンド動作時のメモリ消費が大きすぎる
- 目標: 現在の約1/100のメモリ消費

## 現状分析

### メモリ消費内訳（推定）
| 要素 | 常駐 | 生成時ピーク | 備考 |
|------|------|-------------|------|
| フォント7種 | ~10 MB | - | 初期化時に全読み込み、解放なし |
| 背景画像 | - | ~8.3 MB | 毎回LOAD & RESIZE |
| RGBA画像 | - | ~8.3 MB | 1920x1080 RGBA |
| RGB変換用画像 | - | ~6.2 MB | RGBA→RGB変換時 |
| アイコン画像 | - | ~0.01 MB | 毎回LOAD |
| CalendarClient | ~1 MB | - | 認証トークン保持 |
| QTimer×4 | ~0.1 MB | - | 自動更新・スリープ検知等 |
| **合計（概算）** | **~11 MB** | **~33 MB** | ピーク時 ~44 MB |

### 問題点
1. **フォント常駐**: 7種のフォントが未使用時もメモリに常駐（~10MB）
2. **毎回のフル画像生成**: 背景画像を毎回読み込み・リサイズ
3. **画像の重複保持**: RGBA→RGB変換時に2枚分のメモリ消費
4. **スリープ検知タイマー**: 60秒間隔でポーリング

## 設計方針

### Phase 1: 遅延初期化（即効果）
- フォントを遅延ロード化（使用時に初めて読み込み、使用後に解放）
- 背景画像をキャッシュ化（同じ背景なら再読み込みしない）

### Phase 2: 画像生成最適化
- RGBA→RGB変換の効率化（in-placeまたはストリーム処理）
- アイコン画像を初期化時に1回だけ読み込みキャッシュ
- 未使用のPIL Imageオブジェクトを明示的に close()

### Phase 3: バックグラウンド最適化
- 壁紙生成後にImageGeneratorの重いリソースを解放
- QTimerのみ保持し、生成時のみリソースを確保→解放パターン
- スリープ検知をOS通知ベースに変更（ポーリング廃止）

### 目標メモリ消費
| 状態 | 現在（推定） | 目標 |
|------|-------------|------|
| アイドル時 | ~11 MB | ~0.5 MB |
| 生成時ピーク | ~44 MB | ~25 MB |
| 生成後 | ~11 MB | ~0.5 MB |

## タスク
- [ ] フォントの遅延ロード・使用後解放を実装
- [ ] 背景画像キャッシュ機構を実装
- [ ] アイコン画像の初回読み込みキャッシュを実装
- [ ] PIL Imageの明示的close()を壁紙生成フローに追加
- [ ] RGBA→RGB変換の効率化
- [ ] 壁紙生成後のリソース解放メソッドを追加
- [ ] メモリ消費計測テストを追加（psutil利用）
- [ ] 既存テストの通過を確認

## テスト方針
- 各最適化の前後でメモリ消費を計測
- 遅延ロードの正常動作テスト（フォントが必要時に読み込まれること）
- リソース解放後の再生成テスト
- 既存の584テストが全て通ること
